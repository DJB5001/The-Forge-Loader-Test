-- dj_tab_mining.lua
-- Auto Mining with MULTI-ROCK SELECTION

return function(Window, Rayfield, Utils)
   local MiningTab = Window:CreateTab("⛏️ Mining", nil)
   
   MiningTab:CreateSection("Configuration")
   
   local Players = game:GetService("Players")
   local LocalPlayer = Players.LocalPlayer
   local RunService = game:GetService("RunService")
   
   local miningEnabled = false
   local selectedRockTypes = {"Boulder"}  -- Now a list!
   local selectedLocation = "Island1CaveDeep"
   local miningConnection = nil
   local noclipConnection = nil
   local flyConnection = nil
   local currentTargetRock = nil
   local isMovingToRock = false
   local flySpeed = 60
   local bodyVelocity = nil
   local bodyGyro = nil
   local characterAddedConnection = nil
   local rockStartTime = 0
   local ROCK_TIMEOUT = 360
   local currentRockTypeIndex = 1  -- Track which type we're currently mining
   
   local rockLocations = {
      "All",
      "Island1CaveDeep",
      "Island1CaveMid",
      "Island1CaveStart",
      "Roof",
      "Island2CaveDanger1",
      "Island2CaveDanger2",
      "Island2CaveDanger3",
      "Island2CaveDanger4",
      "Island2CaveDangerClosed",
      "Island2CaveDeep",
      "Island2CaveLavaClosed",
      "Island2CaveMid",
      "Island2CaveStart",
      "Island2GoblinCave",
      "Island2VolcanicDepths"
   }
   
   local rockTypes = {
      "Rock",
      "Boulder",
      "Pebble",
      "LuckyBlock",
      "Light Crystal",
      "Volcanic Rock",
      "Basalt Core",
      "Basalt Rock",
      "Basalt Vein",
      "Violet Crystal",
      "Earth Crystal",
      "Cyan Crystal",
      "Crimson Crystal"
   }
   
   print("[MINING] Loading...")
   
   -- IMPROVED: Find next rock from ANY selected type
   local function findNextRock(locationFilter)
      if #selectedRockTypes == 0 then return nil, nil end
      
      local rocksFolder = workspace:FindFirstChild("Rocks")
      if not rocksFolder then return nil, nil end
      
      local locationsToSearch = {}
      if locationFilter == "All" then
         for i = 2, #rockLocations do
            table.insert(locationsToSearch, rockLocations[i])
         end
      else
         locationsToSearch = {locationFilter}
      end
      
      -- Try each selected rock type in order
      for i = 1, #selectedRockTypes do
         local index = ((currentRockTypeIndex - 1 + i - 1) % #selectedRockTypes) + 1
         local rockType = selectedRockTypes[index]
         
         for _, locationName in ipairs(locationsToSearch) do
            local locationFolder = rocksFolder:FindFirstChild(locationName)
            
            if locationFolder then
               for _, child in pairs(locationFolder:GetChildren()) do
                  if child.Name == "SpawnLocation" then
                     local rock = child:FindFirstChild(rockType)
                     if rock then
                        currentRockTypeIndex = index
                        print("[MINING] Found", rockType, "in", locationName)
                        return rock, child
                     end
                  end
               end
            end
         end
      end
      
      return nil, nil
   end
   
   local function enableNoclip()
      if noclipConnection then return end
      noclipConnection = RunService.Stepped:Connect(function()
         if not miningEnabled then return end
         local character = LocalPlayer.Character
         if character then
            for _, part in pairs(character:GetDescendants()) do
               if part:IsA("BasePart") then part.CanCollide = false end
            end
         end
      end)
   end
   
   local function disableNoclip()
      if noclipConnection then noclipConnection:Disconnect(); noclipConnection = nil end
      local character = LocalPlayer.Character
      if character then
         for _, part in pairs(character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = true end
         end
      end
   end
   
   local function setupFlyBodies()
      local character = LocalPlayer.Character
      if not character then return false end
      local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
      if not humanoidRootPart then return false end
      
      for _, obj in pairs(humanoidRootPart:GetChildren()) do
         if obj:IsA("BodyVelocity") or obj:IsA("BodyGyro") then obj:Destroy() end
      end
      
      bodyVelocity = Instance.new("BodyVelocity")
      bodyVelocity.Velocity = Vector3.new(0, 0, 0)
      bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
      bodyVelocity.Parent = humanoidRootPart
      
      bodyGyro = Instance.new("BodyGyro")
      bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
      bodyGyro.P = 9e4
      bodyGyro.Parent = humanoidRootPart
      return true
   end
   
   local function enableFly()
      if flyConnection then return end
      if not setupFlyBodies() then task.wait(0.5); setupFlyBodies() end
      
      flyConnection = RunService.Heartbeat:Connect(function()
         if not miningEnabled or not bodyVelocity or not bodyGyro then return end
         local char = LocalPlayer.Character
         if not char then return end
         local hrp = char:FindFirstChild("HumanoidRootPart")
         if not hrp then return end
         
         if isMovingToRock and currentTargetRock then
            local hitbox = currentTargetRock:FindFirstChild("Hitbox")
            
            if hitbox and hitbox:IsA("BasePart") then
               local hitboxPos = hitbox.Position
               local targetPos = hitboxPos - Vector3.new(0, 2, 0)
               
               local direction = (targetPos - hrp.Position).Unit
               local distance = (targetPos - hrp.Position).Magnitude
               local maxSpeed = math.min(flySpeed, 60)
               local speed = math.min(distance * 2, maxSpeed)
               
               if distance > 2 then
                  bodyVelocity.Velocity = direction * speed
                  bodyGyro.CFrame = CFrame.new(hrp.Position, targetPos)
               else
                  bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                  isMovingToRock = false
               end
            else
               local rockPart = currentTargetRock.PrimaryPart or currentTargetRock:FindFirstChildWhichIsA("BasePart")
               if rockPart then
                  local targetPos = rockPart.Position - Vector3.new(0, 2, 0)
                  local direction = (targetPos - hrp.Position).Unit
                  local distance = (targetPos - hrp.Position).Magnitude
                  local speed = math.min(distance * 2, math.min(flySpeed, 60))
                  
                  if distance > 2 then
                     bodyVelocity.Velocity = direction * speed
                     bodyGyro.CFrame = CFrame.new(hrp.Position, targetPos)
                  else
                     bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                     isMovingToRock = false
                  end
               else
                  bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                  isMovingToRock = false
               end
            end
         else
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
         end
      end)
   end
   
   local function disableFly()
      if flyConnection then flyConnection:Disconnect(); flyConnection = nil end
      if bodyVelocity then bodyVelocity:Destroy(); bodyVelocity = nil end
      if bodyGyro then bodyGyro:Destroy(); bodyGyro = nil end
   end
   
   local function moveToRock(rock)
      if not rock then return false end
      
      if rock ~= currentTargetRock then
         rockStartTime = tick()
         print("[MINING] Target:", rock.Name)
      end
      
      currentTargetRock = rock
      isMovingToRock = true
      return true
   end
   
   local function activateMiningTool()
      if not miningEnabled then return end
      task.spawn(function()
         pcall(function()
            local args = {"Pickaxe"}
            game:GetService("ReplicatedStorage")
               :WaitForChild("Shared", 1):WaitForChild("Packages", 1):WaitForChild("Knit", 1)
               :WaitForChild("Services", 1):WaitForChild("ToolService", 1)
               :WaitForChild("RF", 1):WaitForChild("ToolActivated", 1)
               :InvokeServer(unpack(args))
         end)
      end)
   end
   
   local function isRockValid(rock)
      if not rock then return false end
      if not rock.Parent then return false end
      
      local currentTime = tick()
      local timeMining = currentTime - rockStartTime
      
      if timeMining > ROCK_TIMEOUT then
         print("[MINING] Timeout (6min) - switching rock...")
         return false
      end
      
      return true
   end
   
   local function startMining()
      if miningConnection then miningConnection:Disconnect() end
      
      local rockList = table.concat(selectedRockTypes, ", ")
      print("[MINING] Starting:", rockList)
      
      enableNoclip()
      task.wait(0.1)
      enableFly()
      
      if Rayfield then
         Rayfield:Notify({
            Title = "Mining", 
            Content = "Mining: " .. (#selectedRockTypes > 1 and (#selectedRockTypes .. " types") or selectedRockTypes[1]), 
            Duration = 3
         })
      end
      
      local searchTick, spamCount = 0, 0
      local newRock = findNextRock(selectedLocation)
      if newRock then moveToRock(newRock) end
      
      miningConnection = RunService.Heartbeat:Connect(function()
         if not miningEnabled then return end
         searchTick = searchTick + 1
         
         if not isRockValid(currentTargetRock) or searchTick >= 60 then
            searchTick = 0
            local rock = findNextRock(selectedLocation)
            if rock and rock ~= currentTargetRock then 
               moveToRock(rock)
            end
         end
         
         activateMiningTool()
         spamCount = spamCount + 1
         if spamCount >= 200 then spamCount = 0 end
      end)
   end
   
   local function stopMining()
      if miningConnection then miningConnection:Disconnect(); miningConnection = nil end
      disableNoclip()
      disableFly()
      currentTargetRock = nil
      isMovingToRock = false
      rockStartTime = 0
      currentRockTypeIndex = 1
      print("[MINING] Stopped")
   end
   
   local function setupRespawnHandler()
      if characterAddedConnection then characterAddedConnection:Disconnect() end
      
      characterAddedConnection = LocalPlayer.CharacterAdded:Connect(function(newCharacter)
         if miningEnabled then
            print("[MINING] Respawned - restarting...")
            task.wait(1)
            disableFly()
            task.wait(0.5)
            enableNoclip()
            task.wait(0.1)
            enableFly()
            
            currentTargetRock = nil
            isMovingToRock = false
            rockStartTime = 0
            local newRock = findNextRock(selectedLocation)
            if newRock then moveToRock(newRock) end
         end
      end)
   end
   
   setupRespawnHandler()
   
   -- UI
   MiningTab:CreateDropdown({
      Name = "Location",
      Options = rockLocations,
      CurrentOption = {"Island1CaveDeep"},
      MultipleOptions = false,
      Flag = "MiningLocation",
      Callback = function(Options)
         selectedLocation = Options[1] or "All"
      end,
   })
   
   -- MULTI-SELECT DROPDOWN!
   MiningTab:CreateDropdown({
      Name = "Rock Types (Multi-Select)",
      Options = rockTypes,
      CurrentOption = {"Boulder"},
      MultipleOptions = true,  -- ENABLED!
      Flag = "MiningRockTypes",
      Callback = function(Options)
         selectedRockTypes = Options
         if #selectedRockTypes == 0 then
            selectedRockTypes = {"Boulder"}
         end
         currentRockTypeIndex = 1
         print("[MINING] Selected:", table.concat(selectedRockTypes, ", "))
      end,
   })
   
   MiningTab:CreateSlider({
      Name = "Fly Speed (Max 60)",
      Range = {30, 60},
      Increment = 5,
      Suffix = "Speed",
      CurrentValue = 60,
      Flag = "MiningFlySpeed",
      Callback = function(Value)
         flySpeed = Value
      end,
   })
   
   MiningTab:CreateSection("Control")
   
   MiningTab:CreateToggle({
      Name = "Auto Mining",
      CurrentValue = false,
      Flag = "AutoMining",
      Callback = function(enabled)
         miningEnabled = enabled
         if enabled then
            startMining()
         else
            stopMining()
         end
      end,
   })
   
   MiningTab:CreateParagraph({
      Title = "Multi-Rock Mining",
      Content = "Select MULTIPLE rock types!\nAuto-switches when unavailable:\n- Prioritizes first selected\n- Cycles through all selected\n- Smart type rotation\n\nExample: Select Boulder + Rock + Pebble\nMines Boulders until none available,\nthen switches to Rocks, then Pebbles!"
   })
   
   MiningTab:CreateParagraph({
      Title = "Features",
      Content = "13 Rock Types + Multi-select\n17 Locations | World 1 & 2\nAuto fly + noclip\nAuto-restart after death\n6-min timeout system\nAnti-TP safe (max 60 speed)\n\nSettings auto-saved!"
   })
   
   print("[MINING] Ready!")
   
   game:GetService("Players").PlayerRemoving:Connect(function(player)
      if player == LocalPlayer then 
         stopMining()
         if characterAddedConnection then characterAddedConnection:Disconnect() end
      end
   end)
end