-- dj_ui_base.lua
-- Robust UI bootstrap: Rayfield (primary, multi-source) with OrionLib fallback (silent)
-- Neutral look + Discord invite enabled

local UIBase = {}

-- ========= helpers =========
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")

local function httpget(url)
   local ok, res = pcall(function() return game:HttpGet(url, true) end)
   if ok and type(res) == "string" and #res > 0 then return res end
   local env = getfenv()
   local req = env.http_request or env.request or (env.syn and env.syn.request)
   if req then
      local ok2, r = pcall(function() return req({ Url = url, Method = "GET" }) end)
      if ok2 and r then
         local body = (type(r)=="table" and (r.Body or r.body)) or (type(r)=="string" and r) or ""
         if type(body) == "string" and #body > 0 then return body end
      end
   end
   return nil
end

local function destroyOldRayfield()
   for _,v in ipairs(CoreGui:GetChildren()) do
      if v.Name == "Rayfield" then pcall(function() v:Destroy() end) end
   end
end

-- ========= Rayfield primary (multi-source) =========
local function tryLoadRayfield()
   destroyOldRayfield()
   local SOURCES = {
      "https://sirius.menu/rayfield",
      "https://raw.githubusercontent.com/shlexware/Rayfield/main/source"
   }
   for _, url in ipairs(SOURCES) do
      local src = httpget(url)
      if src and src:find("return Rayfield") then
         local ok1, chunk = pcall(loadstring, src)
         if ok1 and chunk then
            local ok2, lib = pcall(chunk)
            if ok2 and lib then return lib end
         end
      end
   end
   return nil, "all rayfield sources failed"
end

-- ========= Orion fallback + adapter =========
local function tryLoadOrionAdapter()
   local ORION_URL = "https://raw.githubusercontent.com/shlexware/Orion/main/source"
   local src = httpget(ORION_URL)
   if not src then return nil, "orion download failed" end
   local ok, chunk = pcall(loadstring, src)
   if not ok or not chunk then return nil, "orion compile failed" end
   local ok2, OrionLib = pcall(chunk)
   if not ok2 or not OrionLib then return nil, "orion init failed" end

   local RF = {}
   function RF:Notify(opts)
      OrionLib:MakeNotification({
         Name = opts.Title or "Info",
         Content = opts.Content or "",
         Time = (opts.Duration or 4)
      })
   end

   local WindowMT = {}
   WindowMT.__index = WindowMT

   function WindowMT:CreateTab(name, _icon)
      local Tab = self._orion:MakeTab({ Name = name or "Tab", Icon = _icon or "", PremiumOnly = false })
      local TabWrap = {}
      function TabWrap:CreateSection(_) end
      function TabWrap:CreateButton(def)
         Tab:AddButton({ Name = def.Name or "Button", Callback = function() if def.Callback then pcall(def.Callback) end end })
      end
      function TabWrap:CreateToggle(def)
         Tab:AddToggle({ Name = def.Name or "Toggle", Default = not not def.CurrentValue, Callback = function(val) if def.Callback then pcall(def.Callback, val) end end })
      end
      function TabWrap:CreateSlider(def)
         Tab:AddSlider({ Name = def.Name or "Slider", Min = (def.Range and def.Range[1]) or 0, Max = (def.Range and def.Range[2]) or 100, Default = def.CurrentValue or 0, Increment = def.Increment or 1, Callback = function(v) if def.Callback then pcall(def.Callback, v) end end })
      end
      function TabWrap:CreateInput(def)
         Tab:AddTextbox({ Name = def.Name or "Input", Default = "", TextDisappear = def.RemoveTextAfterFocusLost ~= false, Callback = function(txt) if def.Callback then pcall(def.Callback, txt) end end })
      end
      function TabWrap:CreateDropdown(def)
         Tab:AddDropdown({ Name = def.Name or "Dropdown", Options = def.Options or {}, Default = (not def.MultipleOptions) and (def.CurrentOption or (def.Options and def.Options[1])) or nil, Multi = def.MultipleOptions and true or false, Callback = function(val) if def.Callback then pcall(def.Callback, val) end end })
      end
      return TabWrap
   end

   function RF:CreateWindow(opts)
      local win = OrionLib:MakeWindow({ Name = (opts and opts.Name) or "DJ HUB | The Forge", HidePremium = true, SaveConfig = false, IntroText = (opts and opts.LoadingTitle) or "DJ HUB is loading..." })
      task.delay(0.2, function()
         if UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled then
            local rf = CoreGui:FindFirstChildOfClass("ScreenGui")
            if rf then local s = Instance.new("UIScale") s.Scale = 1.08 s.Parent = rf end
         end
      end)
      OrionLib:Init()
      return setmetatable({ _orion = win }, WindowMT)
   end

   local function createWindow(opts)
      local W = RF:CreateWindow(opts or { Name = "DJ HUB | The Forge", LoadingTitle = "DJ HUB is loading...", LoadingSubtitle = "Please wait", })
      return RF, W
   end

   return { lib = RF, factory = createWindow }
end

-- ========= Public API =========
function UIBase.createWindow()
   local lib = tryLoadRayfield()
   if lib then
      local win = lib:CreateWindow({
         Name = "DJ HUB | The Forge",
         LoadingTitle = "DJ HUB is loading...",
         LoadingSubtitle = "Please wait",
         ConfigurationSaving = { Enabled = false },
         Discord = { Enabled = true, Invite = "MTXnFfHXW9", RememberJoins = true },
         KeySystem = false,
      })
      task.delay(0.2, function()
         if UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled then
            local rf = CoreGui:FindFirstChild("Rayfield", true)
            if rf then local scale = Instance.new("UIScale") scale.Scale = 1.08 scale.Parent = rf end
         end
      end)
      return lib, win
   end

   local ok, pack = pcall(tryLoadOrionAdapter)
   if ok and pack and pack.lib and pack.factory then
      local RF, WIN = pack.factory({ Name = "DJ HUB | The Forge", LoadingTitle = "DJ HUB is loading...", LoadingSubtitle = "Please wait", })
      return RF, WIN
   end

   error("UI load failed (Rayfield & Orion)")
end

return UIBase