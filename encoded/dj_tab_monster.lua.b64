-- dj_tab_monster.lua
-- With mob respawn detection - waits when all mobs are dead

return function(Window, Rayfield, Utils)
   local MonsterTab = Window:CreateTab("👾 Monster Farm", nil)
   
   MonsterTab:CreateSection("Configuration")
   
   local Players = game:GetService("Players")
   local LocalPlayer = Players.LocalPlayer
   local RunService = game:GetService("RunService")
   local ReplicatedStorage = game:GetService("ReplicatedStorage")
   
   local farmEnabled = false
   local farmBlockingEnabled = false
   local selectedMonsters = {"Zombie"}
   local farmConnection = nil
   local noclipConnection = nil
   local flyConnection = nil
   local blockConnection = nil
   local currentTargetMonster = nil
   local isMovingToMonster = false
   local flySpeed = 60
   local bodyVelocity = nil
   local bodyGyro = nil
   local autoBlockEnabled = false
   local isBlocking = false
   local lastBlockCheck = 0
   local blockStartTime = 0
   local characterAddedConnection = nil
   local monsterStartTime = 0
   local MONSTER_TIMEOUT = 360
   local MAX_BLOCK_DISTANCE = 100
   local BLOCK_DURATION = 0.5
   local BLOCK_CHECK_INTERVAL = 0.01
   local currentMonsterTypeIndex = 1
   local previousAttackingStates = {}
   local lastMobCheckTime = 0
   local MOB_CHECK_INTERVAL = 2
   local lastNoMobWarning = 0
   local NO_MOB_WARNING_INTERVAL = 10
   local waitingForRespawn = false
   
   local monsterTypes = {
      "Bomber",
      "Skeleton Rogue",
      "Axe Skeleton",
      "Deathaxe Skeleton",
      "Elite Rogue Skeleton",
      "Elite Deathaxe Skeleton",
      "Zombie",
      "Delver Zombie",
      "Elite Zombie",
      "Brute Zombie",
      "Reaper",
      "Blight Puromancer",
      "Slime",
      "Blazing Slime"
   }
   
   print("[MONSTER FARM] Loading with mob respawn detection...")
   
   local function getPlayerNameFromClaim(claimValue)
      if not claimValue then return nil end
      if claimValue:IsA("Player") then return claimValue.Name end
      if claimValue:IsA("Model") then return claimValue.Name end
      if claimValue.Name then return claimValue.Name end
      return nil
   end
   
   local function isMonsterClaimedByOther(monster)
      if not monster then return false end
      local status = monster:FindFirstChild("Status")
      if not status then return false end
      local damageDone = status:FindFirstChild("DamageDone")
      if not damageDone then return false end
      local claimValue = damageDone.Value
      if not claimValue then return false end
      local claimName = getPlayerNameFromClaim(claimValue)
      if not claimName or claimName == "" then return false end
      return claimName ~= LocalPlayer.Name
   end
   
   local function isMonsterClaimedByUs(monster)
      if not monster then return false end
      local status = monster:FindFirstChild("Status")
      if not status then return false end
      local damageDone = status:FindFirstChild("DamageDone")
      if not damageDone then return false end
      local claimValue = damageDone.Value
      if not claimValue then return false end
      local claimName = getPlayerNameFromClaim(claimValue)
      if not claimName then return false end
      return claimName == LocalPlayer.Name
   end
   
   local function getDistanceToMonster(monster)
      if not monster then return math.huge end
      local char = LocalPlayer.Character
      if not char then return math.huge end
      local hrp = char:FindFirstChild("HumanoidRootPart")
      if not hrp then return math.huge end
      local monsterPart = monster:FindFirstChild("HumanoidRootPart") 
                       or monster.PrimaryPart 
                       or monster:FindFirstChildWhichIsA("BasePart")
      if not monsterPart then return math.huge end
      return (hrp.Position - monsterPart.Position).Magnitude
   end
   
   local function findAllMyMonsters()
      local living = workspace:FindFirstChild("Living")
      if not living then return {} end
      
      local myMonsters = {}
      for _, entity in pairs(living:GetChildren()) do
         local status = entity:FindFirstChild("Status")
         if status then
            local damageDone = status:FindFirstChild("DamageDone")
            if damageDone and damageDone.Value then
               local claimName = getPlayerNameFromClaim(damageDone.Value)
               if claimName == LocalPlayer.Name then
                  local distance = getDistanceToMonster(entity)
                  if distance <= MAX_BLOCK_DISTANCE then
                     table.insert(myMonsters, entity)
                  end
               end
            end
         end
      end
      return myMonsters
   end
   
   local function countAvailableMonsters()
      local living = workspace:FindFirstChild("Living")
      if not living then return 0 end
      
      local count = 0
      for _, entity in pairs(living:GetChildren()) do
         for _, monsterType in ipairs(selectedMonsters) do
            if entity.Name:find("^" .. monsterType) then
               if not isMonsterClaimedByOther(entity) then
                  count = count + 1
                  break
               end
            end
         end
      end
      return count
   end
   
   local function isMonsterAttacking(monster)
      if not monster then return false end
      
      local status = monster:FindFirstChild("Status")
      if not status then return false end
      
      local attacking = status:FindFirstChild("Attacking")
      if not attacking then return false end
      
      local value = attacking.Value
      
      if type(value) == "boolean" and value == true then 
         return true 
      end
      if type(value) == "number" and value > 0 then 
         return true 
      end
      if type(value) == "string" and (value:lower() == "true" or value == "1") then 
         return true 
      end
      if value ~= nil and value ~= false and value ~= 0 and value ~= "" then 
         return true 
      end
      
      return false
   end
   
   local function startBlock()
      if isBlocking then return end
      
      print("[🛡️] Starting block...")
      
      local success, err = pcall(function()
         ReplicatedStorage:WaitForChild("Shared", 1)
            :WaitForChild("Packages", 1):WaitForChild("Knit", 1)
            :WaitForChild("Services", 1):WaitForChild("ToolService", 1)
            :WaitForChild("RF", 1):WaitForChild("StartBlock", 1)
            :InvokeServer()
         
         isBlocking = true
         blockStartTime = tick()
         print("[🛡️✅] BLOCKING")
         
         task.spawn(function()
            task.wait(BLOCK_DURATION)
            
            if isBlocking then
               pcall(function()
                  ReplicatedStorage:WaitForChild("Shared", 1)
                     :WaitForChild("Packages", 1):WaitForChild("Knit", 1)
                     :WaitForChild("Services", 1):WaitForChild("ToolService", 1)
                     :WaitForChild("RF", 1):WaitForChild("StopBlock", 1)
                     :InvokeServer()
               end)
               
               isBlocking = false
               blockStartTime = 0
               print("[⚔️] Block ended")
            end
         end)
      end)
      
      if not success then
         print("[❌] Block error:", err)
      end
   end
   
   local function stopBlock()
      if not isBlocking then return end
      
      task.spawn(function()
         pcall(function()
            ReplicatedStorage:WaitForChild("Shared", 1)
               :WaitForChild("Packages", 1):WaitForChild("Knit", 1)
               :WaitForChild("Services", 1):WaitForChild("ToolService", 1)
               :WaitForChild("RF", 1):WaitForChild("StopBlock", 1)
               :InvokeServer()
            isBlocking = false
            blockStartTime = 0
         end)
      end)
   end
   
   local function enableAutoBlock()
      if blockConnection then return end
      
      local modeText = (farmEnabled and farmBlockingEnabled) and "Farm" or "Manual"
      print("[BLOCK] Auto-Block enabled (", modeText, "mode)")
      
      blockConnection = RunService.Heartbeat:Connect(function()
         local shouldBlock = (farmEnabled and farmBlockingEnabled) or autoBlockEnabled
         
         if not shouldBlock then 
            if isBlocking then stopBlock() end
            return 
         end
         
         local currentTime = tick()
         if currentTime - lastBlockCheck < BLOCK_CHECK_INTERVAL then return end
         lastBlockCheck = currentTime
         
         local myMonsters = findAllMyMonsters()
         if #myMonsters == 0 then
            previousAttackingStates = {}
            return
         end
         
         for _, monster in ipairs(myMonsters) do
            local monsterId = tostring(monster)
            local currentAttacking = isMonsterAttacking(monster)
            local previousAttacking = previousAttackingStates[monsterId]
            
            if currentAttacking and not previousAttacking then
               print("[⚡] Attacking detected - Blocking!")
               startBlock()
            end
            
            previousAttackingStates[monsterId] = currentAttacking
         end
      end)
   end
   
   local function disableAutoBlock()
      if blockConnection then 
         blockConnection:Disconnect()
         blockConnection = nil
      end
      if isBlocking then stopBlock() end
      previousAttackingStates = {}
      print("[BLOCK] Auto-Block disabled")
   end
   
   local function findNextMonster(excludeMonster)
      if #selectedMonsters == 0 then return nil end
      
      local living = workspace:FindFirstChild("Living")
      if not living then return nil end
      
      for i = 1, #selectedMonsters do
         local index = ((currentMonsterTypeIndex - 1 + i - 1) % #selectedMonsters) + 1
         local monsterType = selectedMonsters[index]
         
         for _, entity in pairs(living:GetChildren()) do
            if entity.Name:find("^" .. monsterType) and entity ~= excludeMonster then
               if not isMonsterClaimedByOther(entity) then
                  currentMonsterTypeIndex = index
                  return entity
               end
            end
         end
      end
      
      return nil
   end
   
   local function enableNoclip()
      if noclipConnection then return end
      noclipConnection = RunService.Stepped:Connect(function()
         if not farmEnabled then return end
         local character = LocalPlayer.Character
         if character then
            for _, part in pairs(character:GetDescendants()) do
               if part:IsA("BasePart") then part.CanCollide = false end
            end
         end
      end)
   end
   
   local function disableNoclip()
      if noclipConnection then noclipConnection:Disconnect(); noclipConnection = nil end
      local character = LocalPlayer.Character
      if character then
         for _, part in pairs(character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = true end
         end
      end
   end
   
   local function setupFlyBodies()
      local character = LocalPlayer.Character
      if not character then return false end
      local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
      if not humanoidRootPart then return false end
      
      for _, obj in pairs(humanoidRootPart:GetChildren()) do
         if obj:IsA("BodyVelocity") or obj:IsA("BodyGyro") then obj:Destroy() end
      end
      
      bodyVelocity = Instance.new("BodyVelocity")
      bodyVelocity.Velocity = Vector3.new(0, 0, 0)
      bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
      bodyVelocity.Parent = humanoidRootPart
      
      bodyGyro = Instance.new("BodyGyro")
      bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
      bodyGyro.P = 9e4
      bodyGyro.Parent = humanoidRootPart
      return true
   end
   
   local function enableFly()
      if flyConnection then return end
      if not setupFlyBodies() then task.wait(0.5); setupFlyBodies() end
      
      flyConnection = RunService.Heartbeat:Connect(function()
         if not farmEnabled or not bodyVelocity or not bodyGyro then return end
         local char = LocalPlayer.Character
         if not char then return end
         local hrp = char:FindFirstChild("HumanoidRootPart")
         if not hrp then return end
         
         if isMovingToMonster and currentTargetMonster and currentTargetMonster.Parent then
            local targetPart = currentTargetMonster:FindFirstChild("HumanoidRootPart") 
                            or currentTargetMonster.PrimaryPart 
                            or currentTargetMonster:FindFirstChildWhichIsA("BasePart")
            
            if targetPart then
               local targetPos = targetPart.Position - Vector3.new(0, 2, 0)
               local direction = (targetPos - hrp.Position).Unit
               local distance = (targetPos - hrp.Position).Magnitude
               local maxSpeed = math.min(flySpeed, 60)
               local speed = math.min(distance * 2, maxSpeed)
               
               if distance > 5 then
                  bodyVelocity.Velocity = direction * speed
                  bodyGyro.CFrame = CFrame.new(hrp.Position, targetPos)
               else
                  bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                  isMovingToMonster = false
               end
            else
               bodyVelocity.Velocity = Vector3.new(0, 0, 0)
               isMovingToMonster = false
            end
         else
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
         end
      end)
   end
   
   local function disableFly()
      if flyConnection then flyConnection:Disconnect(); flyConnection = nil end
      if bodyVelocity then bodyVelocity:Destroy(); bodyVelocity = nil end
      if bodyGyro then bodyGyro:Destroy(); bodyGyro = nil end
   end
   
   local function moveToMonster(monster)
      if not monster then return false end
      
      if monster ~= currentTargetMonster then
         monsterStartTime = tick()
         print("[MONSTER FARM] Target:", monster.Name)
      end
      
      currentTargetMonster = monster
      isMovingToMonster = true
      return true
   end
   
   local function activateWeapon()
      if not farmEnabled then return end
      if isBlocking then return end
      
      task.spawn(function()
         pcall(function()
            local args = {"Weapon"}
            ReplicatedStorage:WaitForChild("Shared", 1):WaitForChild("Packages", 1)
               :WaitForChild("Knit", 1):WaitForChild("Services", 1)
               :WaitForChild("ToolService", 1):WaitForChild("RF", 1)
               :WaitForChild("ToolActivated", 1):InvokeServer(unpack(args))
         end)
      end)
   end
   
   local function isMonsterValid(monster)
      if not monster then return false end
      if not monster.Parent then return false end
      
      local currentTime = tick()
      local timeFighting = currentTime - monsterStartTime
      
      if timeFighting > MONSTER_TIMEOUT then
         print("[MONSTER FARM] Timeout (6min) - switching monster...")
         return false
      end
      
      if isMonsterClaimedByUs(monster) then return true end
      if isMonsterClaimedByOther(monster) then return false end
      return true
   end
   
   local function checkForNewMobs()
      local currentTime = tick()
      if currentTime - lastMobCheckTime < MOB_CHECK_INTERVAL then return end
      lastMobCheckTime = currentTime
      
      local availableCount = countAvailableMonsters()
      
      if availableCount == 0 then
         if not waitingForRespawn then
            waitingForRespawn = true
            print("[⏳] NO MOBS AVAILABLE - Waiting for respawn...")
            if Rayfield then
               Rayfield:Notify({
                  Title = "Monster Farm",
                  Content = "All mobs dead - Waiting for respawn...",
                  Duration = 5
               })
            end
         end
         
         if currentTime - lastNoMobWarning > NO_MOB_WARNING_INTERVAL then
            lastNoMobWarning = currentTime
            print("[⏳] Still waiting for mob respawn...")
         end
         
         currentTargetMonster = nil
         isMovingToMonster = false
         return
      end
      
      if waitingForRespawn then
         waitingForRespawn = false
         print("[✅] Mobs respawned - Resuming farm!")
         if Rayfield then
            Rayfield:Notify({
               Title = "Monster Farm",
               Content = "Mobs respawned - Farming resumed!",
               Duration = 3
            })
         end
      end
      
      if not currentTargetMonster or not currentTargetMonster.Parent then
         local newMonster = findNextMonster(nil)
         if newMonster then
            moveToMonster(newMonster)
         end
      end
   end
   
   local function startFarming()
      if farmConnection then farmConnection:Disconnect() end
      
      local monsterList = table.concat(selectedMonsters, ", ")
      print("[MONSTER FARM] Farming:", monsterList)
      
      if farmBlockingEnabled then
         enableAutoBlock()
         print("[FARM] Mode: Attack + Smart Block")
      else
         print("[FARM] Mode: Attack ONLY")
      end
      
      enableNoclip()
      task.wait(0.1)
      enableFly()
      
      if Rayfield then
         Rayfield:Notify({
            Title = "Monster Farm", 
            Content = "Farming: " .. (#selectedMonsters > 1 and (#selectedMonsters .. " types") or selectedMonsters[1]), 
            Duration = 3
         })
      end
      
      local spamCount = 0
      local newMonster = findNextMonster(nil)
      if newMonster then moveToMonster(newMonster) end
      
      farmConnection = RunService.Heartbeat:Connect(function()
         if not farmEnabled then return end
         
         checkForNewMobs()
         
         if waitingForRespawn then
            return
         end
         
         local valid = isMonsterValid(currentTargetMonster)
         if not valid then
            local monster = findNextMonster(currentTargetMonster)
            if monster and monster ~= currentTargetMonster then
               moveToMonster(monster)
            end
         end
         
         if not isBlocking then
            activateWeapon()
         end
         
         spamCount = spamCount + 1
         if spamCount >= 200 then spamCount = 0 end
      end)
   end
   
   local function stopFarming()
      if farmConnection then farmConnection:Disconnect(); farmConnection = nil end
      if farmBlockingEnabled then disableAutoBlock() end
      disableNoclip()
      disableFly()
      currentTargetMonster = nil
      isMovingToMonster = false
      monsterStartTime = 0
      currentMonsterTypeIndex = 1
      waitingForRespawn = false
      print("[MONSTER FARM] Stopped")
   end
   
   local function setupRespawnHandler()
      if characterAddedConnection then characterAddedConnection:Disconnect() end
      
      characterAddedConnection = LocalPlayer.CharacterAdded:Connect(function(newCharacter)
         if farmEnabled then
            print("[MONSTER FARM] Respawned - restarting...")
            task.wait(1)
            disableFly()
            task.wait(0.5)
            enableNoclip()
            task.wait(0.1)
            enableFly()
            
            currentTargetMonster = nil
            isMovingToMonster = false
            monsterStartTime = 0
            local newMonster = findNextMonster(nil)
            if newMonster then moveToMonster(newMonster) end
         end
      end)
   end
   
   setupRespawnHandler()
   
   MonsterTab:CreateDropdown({
      Name = "Monster Types (Multi-Select)",
      Options = monsterTypes,
      CurrentOption = {"Zombie"},
      MultipleOptions = true,
      Flag = "MonsterFarmTypes",
      Callback = function(Options)
         selectedMonsters = Options
         if #selectedMonsters == 0 then
            selectedMonsters = {"Zombie"}
         end
         currentMonsterTypeIndex = 1
         print("[MONSTER FARM] Selected:", table.concat(selectedMonsters, ", "))
      end,
   })
   
   MonsterTab:CreateSlider({
      Name = "Fly Speed (Max 60)",
      Range = {30, 60},
      Increment = 5,
      Suffix = "Speed",
      CurrentValue = 60,
      Flag = "MonsterFarmFlySpeed",
      Callback = function(Value)
         flySpeed = Value
      end,
   })
   
   MonsterTab:CreateSection("Control")
   
   MonsterTab:CreateToggle({
      Name = "Auto Farm Monsters",
      CurrentValue = false,
      Flag = "AutoMonsterFarm",
      Callback = function(enabled)
         farmEnabled = enabled
         if enabled then
            startFarming()
         else
            stopFarming()
         end
      end,
   })
   
   MonsterTab:CreateToggle({
      Name = "Enable Smart Blocking (Optional)",
      CurrentValue = false,
      Flag = "FarmSmartBlocking",
      Callback = function(enabled)
         farmBlockingEnabled = enabled
         if farmEnabled then
            if enabled then
               enableAutoBlock()
               print("[FARM] Blocking enabled (unified system)")
            else
               disableAutoBlock()
               print("[FARM] Blocking disabled")
            end
         end
      end,
   })
   
   MonsterTab:CreateParagraph({
      Title = "! NOTE",
      Content = "Farm Blocking and Manual Auto-Block\nuse the SAME system now for\nconsistent timing!"
   })
   
   MonsterTab:CreateToggle({
      Name = "Auto Block (Manual Fighting)",
      CurrentValue = false,
      Flag = "AutoMonsterBlock",
      Callback = function(enabled)
         autoBlockEnabled = enabled
         if enabled then
            enableAutoBlock()
         else
            disableAutoBlock()
         end
      end,
   })
   
   print("[MONSTER FARM] ✅ Ready with mob respawn detection!")
   
   game:GetService("Players").PlayerRemoving:Connect(function(player)
      if player == LocalPlayer then 
         stopFarming()
         if characterAddedConnection then characterAddedConnection:Disconnect() end
      end
   end)
end