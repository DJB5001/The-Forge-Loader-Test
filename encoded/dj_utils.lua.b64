-- dj_utils.lua
-- Common helper functions for DJ HUB

local Utils = {}

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Safe Wait (heartbeat based)
function Utils.fastWait(sec)
   local t = os.clock() + (sec or 0.05)
   repeat RunService.Heartbeat:Wait() until os.clock() > t
end

-- Cached descendants for performance
local DescCache = {
   PlayerGui = { list=nil, t=0 },
   Replicated = { list=nil, t=0 },
   interval = 10
}
function Utils.getCachedDescendants(container, key)
   local now = os.clock()
   local bucket = DescCache[key]
   if not bucket or (now - bucket.t) > DescCache.interval or not bucket.list then
      local ok, list = pcall(function() return container:GetDescendants() end)
      if ok and list then
         bucket = bucket or {}
         bucket.list, bucket.t = list, now
         DescCache[key] = bucket
      end
   end
   return (bucket and bucket.list) or {}
end

-- SafeFind (by path)
function Utils.safeFindInstance(root, pathTbl, timeout)
   timeout = timeout or 8
   local node = root
   for _, name in ipairs(pathTbl) do
      node = node and (node:FindFirstChild(name) or node:WaitForChild(name, timeout))
      if not node then return nil end
   end
   return node
end

-- Remote cache
local RemoteCache = {}
function Utils.getRemoteCached(pathTbl)
   local key = table.concat(pathTbl,"/")
   if RemoteCache[key] and RemoteCache[key].Parent then return RemoteCache[key] end
   local obj = Utils.safeFindInstance(ReplicatedStorage, pathTbl, 5)
   if obj then RemoteCache[key] = obj end
   return obj
end

-- Clipboard helper
function Utils.copyToClipboard(text)
    if typeof(text) ~= "string" or text == "" then return false end
    local ok, env = false, getfenv()
    local clipboardFns = {
        env.setclipboard, env.toclipboard,
        (env.syn and env.syn.write_clipboard),
        (env.clipboard and env.clipboard.set),
        env.writeclipboard, env.write_clipboard, env.to_clipboard
    }
    for _, fn in ipairs(clipboardFns) do
        if fn and pcall(fn, text) then ok = true break end
    end
    if not ok then warn("[DJ HUB] Clipboard not available! Manual link: " .. text) end
    return ok
end

return Utils