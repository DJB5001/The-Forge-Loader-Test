-- dj_tab_key.lua
-- Junkie Key System verification tab (Get Link + Verify)
-- Adds: persistent local key storage + auto-load/auto-verify
-- Exports: function(Window, Rayfield, Utils, Config, onVerified) -> KeyTab

return function(Window, Rayfield, Utils, Config, onVerified)
   ----------------------------------------------------------------
   -- FS helpers (persistent storage)
   ----------------------------------------------------------------
   local Players = game:GetService("Players")
   local LP = Players.LocalPlayer
   local USER_ID = tostring(LP and LP.UserId or "User")
   local function hasFS()
      local env = getfenv()
      return typeof(writefile)=="function"
         and typeof(readfile)=="function"
         and typeof(makefolder)=="function"
         and typeof(isfile)=="function"
         and typeof(isfolder)=="function"
         and typeof(delfile)=="function"
   end
   local SAVE_DIR = "DJHub/Keys"
   local function ensureSaveDir()
      if not hasFS() then return false end
      pcall(function()
         if not isfolder("DJHub") then makefolder("DJHub") end
         if not isfolder(SAVE_DIR) then makefolder(SAVE_DIR) end
      end)
      return isfolder(SAVE_DIR)
   end
   local function sanitize(s) return (tostring(s or "")):gsub("[^%w%-%._ ]","_") end
   local function keyFilePath(service)
      return ("%s/%s_%s.json"):format(SAVE_DIR, sanitize(USER_ID), sanitize(service or "default"))
   end

   local HttpService = game:GetService("HttpService")
   local function saveKeyToDisk(service, key)
      if not ensureSaveDir() then return false, "No FS" end
      local data = { key = tostring(key or ""), saved = os.time() }
      local ok, enc = pcall(function() return HttpService:JSONEncode(data) end)
      if not ok then return false, "Encode fail" end
      local f = keyFilePath(service)
      local okw, why = pcall(function() writefile(f, enc) end)
      return okw, why
   end
   local function loadKeyFromDisk(service)
      if not hasFS() then return nil end
      local f = keyFilePath(service)
      if not isfile(f) then return nil end
      local okr, raw = pcall(readfile, f); if not okr or type(raw)~="string" or #raw==0 then return nil end
      local okj, obj = pcall(function() return HttpService:JSONDecode(raw) end)
      if okj and type(obj)=="table" and type(obj.key)=="string" and obj.key~="" then
         return obj.key
      end
      return nil
   end
   local function deleteSavedKey(service)
      if not hasFS() then return false end
      local f = keyFilePath(service)
      if isfile(f) then pcall(delfile, f) end
      return true
   end

   ----------------------------------------------------------------
   -- Improved HTTP helper (multiple methods)
   ----------------------------------------------------------------
   local function httpFetch(url, timeout)
      timeout = timeout or 20
      
      -- Method 1: game:HttpGet (most compatible)
      local ok1, res1 = pcall(function()
         return game:HttpGet(url, true)
      end)
      if ok1 and type(res1) == "string" and #res1 > 50 then 
         return res1 
      end

      -- Method 2: game:HttpGetAsync
      local ok2, res2 = pcall(function()
         return game:HttpGetAsync(url)
      end)
      if ok2 and type(res2) == "string" and #res2 > 50 then 
         return res2 
      end

      -- Method 3: HttpService
      local ok3, res3 = pcall(function()
         return HttpService:GetAsync(url, true)
      end)
      if ok3 and type(res3) == "string" and #res3 > 50 then 
         return res3 
      end

      -- Method 4: Executor request
      local env = getfenv()
      local req = env.http_request or env.request or (env.syn and env.syn.request) or env.http.request
      if req then
         local ok4, res4 = pcall(function()
            return req({
               Url = url,
               Method = "GET",
               Headers = { 
                  ["User-Agent"] = "Mozilla/5.0",
                  ["Accept"] = "*/*"
               }
            })
         end)
         if ok4 and res4 then
            local body = (type(res4)=="table" and (res4.Body or res4.body)) or (type(res4)=="string" and res4) or ""
            if type(body) == "string" and #body > 50 then
               return body
            end
         end
      end

      return nil
   end

   ----------------------------------------------------------------
   -- Load Junkie SDK
   ----------------------------------------------------------------
   local function loadJunkieSDK()
      local url = "https://junkie-development.de/sdk/JunkieKeySystem.lua"
      local src = httpFetch(url, 25)
      
      if not src or src == "" or #src < 100 then 
         return nil, "Failed to download SDK (check internet connection)" 
      end
      
      local ok, chunk = pcall(loadstring, src)
      if not ok or not chunk then 
         return nil, "Failed to compile SDK" 
      end
      
      local ok2, sdk = pcall(chunk)
      if not ok2 or not sdk then 
         return nil, "Failed to initialize SDK" 
      end
      
      return sdk, nil
   end

   ----------------------------------------------------------------
   -- Helpers to normalize SDK responses
   ----------------------------------------------------------------
   local function normalizeLink(result)
      if typeof(result) == "string" then
         -- Check if it's JSON
         if result:find("^{") and result:find("}$") then
            local ok, obj = pcall(function() return HttpService:JSONDecode(result) end)
            if ok and typeof(obj) == "table" then
               return normalizeLink(obj)
            end
         end
         -- Return direct string (URL)
         if result:match("^https?://") then
            return result
         end
      elseif typeof(result) == "table" then
         return result.url or result.link or result.Link or result.URL
             or (result.data and (result.data.url or result.data.link))
             or (result.success and result.data and result.data.url)
             or (typeof(result[1]) == "string" and result[1])
      end
      return nil
   end

   local function normalizeBool(res)
      if typeof(res) == "boolean" then return res end
      
      if typeof(res) == "string" then
         -- Check if it's JSON
         if res:find("^{") and res:find("}$") then
            local ok, obj = pcall(function() return HttpService:JSONDecode(res) end)
            if ok and typeof(obj) == "table" then
               return normalizeBool(obj)
            end
         end
         local s = res:lower()
         if s == "true" or s == "success" then return true end
         if s == "false" or s == "fail" then return false end
      elseif typeof(res) == "table" then
         if res.valid   ~= nil then return not not res.valid end
         if res.status  ~= nil then return not not res.status end
         if res.success ~= nil then return not not res.success end
         if res.data and res.data.valid ~= nil then return not not res.data.valid end
      end
      return nil
   end

   local function callGetLink(Junkie, api, provider, service)
      local getLinkFn = Junkie.getLink or Junkie.GetLink or Junkie.get_link
      if not getLinkFn then return nil, "SDK has no getLink function" end
      
      local tries = {
         function() return getLinkFn(api, provider, service) end,
         function() return getLinkFn(service, provider, api) end,
         function() return getLinkFn({ api = api, provider = provider, service = service }) end,
      }
      
      for _, f in ipairs(tries) do
         local ok, res = pcall(f)
         if ok and res then
            local link = normalizeLink(res)
            if link and link ~= "" and link:match("^https?://") then 
               return link, nil 
            end
         end
      end
      return nil, "No valid link in SDK response"
   end

   local function callVerifyKey(Junkie, api, key, service)
      local verifyFn = Junkie.verifyKey or Junkie.VerifyKey or Junkie.verify_key or Junkie.verify
      if not verifyFn then return false, "SDK has no verifyKey function" end
      
      local tries = {
         function() return verifyFn(api, key, service) end,
         function() return verifyFn(key, service, api) end,
         function() return verifyFn({ api = api, key = key, service = service }) end,
      }
      
      for _, f in ipairs(tries) do
         local ok, res = pcall(f)
         if ok and res ~= nil then
            local b = normalizeBool(res)
            if b ~= nil then return b, nil end
         end
      end
      return false, "Unknown verify response from SDK"
   end

   ----------------------------------------------------------------
   -- UI
   ----------------------------------------------------------------
   local KeyTab = Window:CreateTab("🔑 Key", nil)
   KeyTab:CreateSection("Key is saved automatically on this device.")
   KeyTab:CreateSection("Verification")

   local enteredKey, keyAlreadyVerified = "", false
   local verifyBusy = false
   local inputRef = nil

   local function notifyOK(msg)
      Rayfield:Notify({ Title = "Key", Content = msg, Duration = 4, Position = "BottomRight" })
   end
   local function notifyErr(msg)
      Rayfield:Notify({ Title = "Key", Content = "❌ "..msg, Duration = 5, Position = "BottomRight" })
   end

   inputRef = KeyTab:CreateInput({
      Name = "Enter your key",
      PlaceholderText = "Paste Junkie key…",
      RemoveTextAfterFocusLost = false,
      Callback = function(text) 
         if text then
            enteredKey = tostring(text):gsub("%s+","")
         end
      end
   })

   KeyTab:CreateButton({
      Name = "Get Key (copy link)",
      Callback = function()
         if keyAlreadyVerified then 
            notifyOK("Key already verified!")
            return 
         end
         
         if not Config or not Config.api or Config.api == "" or Config.api == "YOUR_API_KEY_HERE" then
            return notifyErr("API key not configured")
         end
         
         notifyOK("Loading Junkie SDK...")
         local Junkie, why = loadJunkieSDK()
         if not Junkie then 
            return notifyErr("SDK load failed: "..tostring(why)) 
         end

         local link, why2 = callGetLink(Junkie, Config.api, Config.provider, Config.service)
         if not link then 
            return notifyErr("Link generation failed: "..tostring(why2)) 
         end

         local ok = Utils and Utils.copyToClipboard and Utils.copyToClipboard(link)
         if ok then
            notifyOK("✅ Link copied!\n"..link)
         else
            -- Fallback clipboard
            pcall(function() setclipboard(link) end)
            notifyOK("✅ Open this link:\n"..link)
         end
      end
   })

   -- Store reference to KeyTab for hiding later
   local KeyTabButtonRef = nil

   local function hideKeyTab()
      print("🔑 [KEY] Attempting to hide Key tab...")
      
      pcall(function()
         -- Method 1: Hide via stored button reference
         if KeyTabButtonRef then
            print("✅ [KEY] Using stored button reference")
            KeyTabButtonRef.Visible = false
            if KeyTabButtonRef.Parent then
               KeyTabButtonRef.Parent.Visible = false
            end
            return
         end
         
         -- Method 2: Search through Rayfield UI
         local PlayerGui = game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
         
         for _, gui in pairs(PlayerGui:GetChildren()) do
            if gui.Name:find("Rayfield") or gui.ClassName == "ScreenGui" then
               -- Find all buttons that might be the Key tab
               for _, obj in pairs(gui:GetDescendants()) do
                  if obj:IsA("TextButton") then
                     local text = obj.Text or ""
                     
                     -- Check for Key tab indicators
                     if text:find("🔑") or text:find("Key") then
                        print("✅ [KEY] Found Key button, hiding:", text)
                        obj.Visible = false
                        
                        -- Hide parent too
                        local parent = obj.Parent
                        if parent and parent:IsA("Frame") then
                           parent.Visible = false
                        end
                     end
                  end
               end
            end
         end
      end)
   end

   local function doVerifyFlow(keyToUse, opts)
      opts = opts or {}
      if verifyBusy or keyAlreadyVerified then return end
      
      if not Config or not Config.api or Config.api == "" or Config.api == "YOUR_API_KEY_HERE" then
         return notifyErr("API key not configured")
      end
      
      keyToUse = (keyToUse or ""):gsub("%s+","")
      if keyToUse == "" then
         return notifyErr("Please enter a key")
      end

      verifyBusy = true
      if not opts.silent then
         notifyOK("Verifying key...")
      end

      local Junkie, why = loadJunkieSDK()
      if not Junkie then 
         verifyBusy = false
         return notifyErr("SDK load failed: "..tostring(why)) 
      end

      local valid, why2 = callVerifyKey(Junkie, Config.api, keyToUse, Config.service)
      verifyBusy = false

      if not valid then
         if opts.fromSaved then
            notifyErr("Saved key expired. Get a new one!")
            deleteSavedKey(Config.service)
         else
            notifyErr("Invalid key! "..tostring(why2 or ""))
         end
         return
      end

      -- Success!
      keyAlreadyVerified = true
      saveKeyToDisk(Config.service, keyToUse)
      notifyOK("✅ Key verified! Loading DJ HUB...")

      -- Hide the key tab after short delay
      task.delay(1, hideKeyTab)

      if typeof(onVerified) == "function" then
         task.delay(0.2, function()
            local okcb, errcb = pcall(onVerified)
            if not okcb then 
               warn("[DJ HUB][Key] onVerified callback error: "..tostring(errcb)) 
            end
         end)
      end
   end

   KeyTab:CreateButton({
      Name = "Verify Key",
      Callback = function()
         doVerifyFlow(enteredKey, { silent = false, fromSaved = false })
      end
   })

   KeyTab:CreateButton({
      Name = "Join Discord",
      Callback = function()
         local link = "https://discord.gg/MTXnFfHXW9"
         local ok = Utils and Utils.copyToClipboard and Utils.copyToClipboard(link)
         if not ok then pcall(function() setclipboard(link) end) end
         notifyOK("👋 Discord invite copied!")
      end
   })

   Rayfield:Notify({
      Title = "Key Required",
      Content = "Get & verify your Junkie key to continue.",
      Duration = 5, Position = "BottomRight"
   })

   ----------------------------------------------------------------
   -- Auto-load saved key (if present)
   ----------------------------------------------------------------
   task.defer(function()
      task.wait(0.5) -- small delay for UI to load
      local saved = loadKeyFromDisk(Config and Config.service)
      if saved and saved ~= "" then
         enteredKey = saved
         pcall(function()
            if inputRef and typeof(inputRef)=="table" and typeof(inputRef.Set)=="function" then
               inputRef:Set(saved)
            end
         end)
         task.wait(0.3)
         doVerifyFlow(saved, { silent = true, fromSaved = true })
      end
   end)
   
   -- Try to capture the tab button reference after creation
   task.defer(function()
      task.wait(0.2)
      pcall(function()
         local PlayerGui = game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
         for _, gui in pairs(PlayerGui:GetChildren()) do
            if gui.Name:find("Rayfield") then
               for _, obj in pairs(gui:GetDescendants()) do
                  if obj:IsA("TextButton") then
                     local text = obj.Text or ""
                     if text:find("🔑") or text:find("Key") then
                        KeyTabButtonRef = obj
                        print("✅ [KEY] Captured tab button reference")
                        break
                     end
                  end
               end
            end
         end
      end)
   end)
   
   -- Return the tab reference
   return KeyTab
end