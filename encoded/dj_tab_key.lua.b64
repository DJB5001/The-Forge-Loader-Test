-- dj_tab_key.lua
-- Simplified Key System with extensive error handling

return function(Window, Rayfield, Utils, Config, onVerified)
   print("[KEY] Starting key tab creation...")
   
   -- Safe guards
   if not Window then 
      warn("[KEY] ERROR: No Window object!")
      return nil 
   end
   if not Rayfield then 
      warn("[KEY] ERROR: No Rayfield object!")
      return nil 
   end
   
   print("[KEY] Window and Rayfield OK")
   
   -- Services
   local Players = game:GetService("Players")
   local HttpService = game:GetService("HttpService")
   local LP = Players.LocalPlayer
   local USER_ID = tostring(LP and LP.UserId or "Unknown")
   
   print("[KEY] Services loaded, UserID:", USER_ID)
   
   -- Filesystem check
   local function hasFS()
      return typeof(writefile)=="function" and typeof(readfile)=="function"
   end
   
   -- Key storage
   local SAVE_DIR = "DJHub/Keys"
   local function getKeyPath()
      return string.format("%s/%s_%s.json", SAVE_DIR, USER_ID, Config and Config.service or "default")
   end
   
   local function saveKey(key)
      if not hasFS() then return false end
      pcall(function()
         if not isfolder("DJHub") then makefolder("DJHub") end
         if not isfolder(SAVE_DIR) then makefolder(SAVE_DIR) end
         local data = HttpService:JSONEncode({key = key, time = os.time()})
         writefile(getKeyPath(), data)
      end)
      return true
   end
   
   local function loadKey()
      if not hasFS() then return nil end
      local path = getKeyPath()
      if not isfile(path) then return nil end
      local ok, raw = pcall(readfile, path)
      if not ok then return nil end
      local ok2, data = pcall(function() return HttpService:JSONDecode(raw) end)
      if ok2 and data and data.key then return data.key end
      return nil
   end
   
   -- SDK loader
   local function loadSDK()
      local url = "https://junkie-development.de/sdk/JunkieKeySystem.lua"
      local ok, src = pcall(function() return game:HttpGet(url, true) end)
      if not ok or not src or #src < 100 then return nil end
      local ok2, chunk = pcall(loadstring, src)
      if not ok2 or not chunk then return nil end
      local ok3, sdk = pcall(chunk)
      if ok3 and sdk then return sdk end
      return nil
   end
   
   -- Create tab
   print("[KEY] Creating tab...")
   local KeyTab
   local ok, err = pcall(function()
      KeyTab = Window:CreateTab("🔑 Key", nil)
   end)
   
   if not ok or not KeyTab then
      warn("[KEY] ERROR creating tab:", err)
      return nil
   end
   
   print("[KEY] Tab created successfully!")
   
   -- Add sections
   pcall(function()
      KeyTab:CreateSection("Key System")
      KeyTab:CreateSection("Saved on this device")
   end)
   
   -- State
   local keyVerified = false
   local enteredKey = ""
   local inputRef
   
   -- Notify helper
   local function notify(msg, isError)
      pcall(function()
         Rayfield:Notify({
            Title = "Key",
            Content = (isError and "❌ " or "")..msg,
            Duration = isError and 5 or 3
         })
      end)
   end
   
   -- Tab deletion
   local function deleteTab()
      print("[KEY] Deleting tab in 1.5 seconds...")
      task.delay(1.5, function()
         pcall(function()
            if KeyTab and KeyTab.Destroy then
               KeyTab:Destroy()
               print("[KEY] Tab destroyed!")
            elseif KeyTab and KeyTab.Hide then
               KeyTab:Hide()
               print("[KEY] Tab hidden!")
            end
         end)
         
         -- Manual fallback
         task.wait(0.3)
         pcall(function()
            for _, gui in pairs(LP:WaitForChild("PlayerGui"):GetChildren()) do
               if gui.Name:find("Rayfield") then
                  for _, obj in pairs(gui:GetDescendants()) do
                     if obj:IsA("TextButton") and obj.Text and obj.Text:find("🔑") then
                        obj:Destroy()
                        print("[KEY] Manual delete:", obj.Name)
                     end
                  end
               end
            end
         end)
      end)
   end
   
   -- Input
   pcall(function()
      inputRef = KeyTab:CreateInput({
         Name = "Enter Key",
         PlaceholderText = "Paste key here",
         RemoveTextAfterFocusLost = false,
         Callback = function(t) enteredKey = tostring(t or ""):gsub("%s+", "") end
      })
   end)
   
   -- Get Link button
   pcall(function()
      KeyTab:CreateButton({
         Name = "Get Key Link",
         Callback = function()
            if keyVerified then return notify("Already verified!") end
            if not Config or not Config.api then return notify("No API key", true) end
            
            notify("Loading...")
            local sdk = loadSDK()
            if not sdk then return notify("SDK failed", true) end
            
            local getLinkFn = sdk.getLink or sdk.GetLink
            if not getLinkFn then return notify("No getLink", true) end
            
            local ok, res = pcall(getLinkFn, Config.api, Config.provider, Config.service)
            if not ok or not res then return notify("Link failed", true) end
            
            local link = res
            if type(res) == "table" then link = res.url or res.link end
            if not link or link == "" then return notify("No link", true) end
            
            pcall(function() setclipboard(link) end)
            notify("✅ Link copied!")
         end
      })
   end)
   
   -- Verify function
   local function verify(key, silent)
      if keyVerified or not key or key == "" then return end
      if not Config or not Config.api then return notify("No API", true) end
      
      if not silent then notify("Verifying...") end
      
      local sdk = loadSDK()
      if not sdk then return notify("SDK error", true) end
      
      local verifyFn = sdk.verifyKey or sdk.VerifyKey
      if not verifyFn then return notify("No verify", true) end
      
      local ok, res = pcall(verifyFn, Config.api, key, Config.service)
      if not ok then return notify("Verify failed", true) end
      
      local valid = false
      if type(res) == "boolean" then 
         valid = res
      elseif type(res) == "table" and res.valid ~= nil then
         valid = res.valid
      elseif type(res) == "string" and res:lower():find("true") then
         valid = true
      end
      
      if not valid then return notify("Invalid key!", true) end
      
      -- SUCCESS!
      keyVerified = true
      saveKey(key)
      notify("✅ Verified!")
      
      deleteTab()
      
      if typeof(onVerified) == "function" then
         task.delay(0.3, function() pcall(onVerified) end)
      end
   end
   
   -- Verify button
   pcall(function()
      KeyTab:CreateButton({
         Name = "Verify Key",
         Callback = function() verify(enteredKey, false) end
      })
   end)
   
   -- Discord button
   pcall(function()
      KeyTab:CreateButton({
         Name = "Discord",
         Callback = function()
            pcall(function() setclipboard("https://discord.gg/MTXnFfHXW9") end)
            notify("👋 Discord copied!")
         end
      })
   end)
   
   -- Notification
   pcall(function()
      Rayfield:Notify({
         Title = "Key Required",
         Content = "Get and verify your key.",
         Duration = 5
      })
   end)
   
   -- Auto-load
   task.defer(function()
      task.wait(0.5)
      local saved = loadKey()
      if saved and saved ~= "" then
         print("[KEY] Found saved key, auto-verifying...")
         enteredKey = saved
         if inputRef and inputRef.Set then
            pcall(function() inputRef:Set(saved) end)
         end
         task.wait(0.3)
         verify(saved, true)
      else
         print("[KEY] No saved key found")
      end
   end)
   
   print("[KEY] Key tab fully loaded!")
   return KeyTab
end