-- dj_tab_key.lua
-- Key System with aggressive tab deletion

return function(Window, Rayfield, Utils, Config, onVerified)
   print("[KEY] Starting key tab creation...")
   
   if not Window then warn("[KEY] ERROR: No Window!") return nil end
   if not Rayfield then warn("[KEY] ERROR: No Rayfield!") return nil end
   
   print("[KEY] Window and Rayfield OK")
   
   local Players = game:GetService("Players")
   local HttpService = game:GetService("HttpService")
   local LP = Players.LocalPlayer
   local USER_ID = tostring(LP and LP.UserId or "Unknown")
   
   print("[KEY] Services loaded, UserID:", USER_ID)
   
   local function hasFS()
      return typeof(writefile)=="function" and typeof(readfile)=="function"
   end
   
   local SAVE_DIR = "DJHub/Keys"
   local function getKeyPath()
      return string.format("%s/%s_%s.json", SAVE_DIR, USER_ID, Config and Config.service or "default")
   end
   
   local function saveKey(key)
      if not hasFS() then return false end
      pcall(function()
         if not isfolder("DJHub") then makefolder("DJHub") end
         if not isfolder(SAVE_DIR) then makefolder(SAVE_DIR) end
         local data = HttpService:JSONEncode({key = key, time = os.time()})
         writefile(getKeyPath(), data)
      end)
      return true
   end
   
   local function loadKey()
      if not hasFS() then return nil end
      local path = getKeyPath()
      if not isfile(path) then return nil end
      local ok, raw = pcall(readfile, path)
      if not ok then return nil end
      local ok2, data = pcall(function() return HttpService:JSONDecode(raw) end)
      if ok2 and data and data.key then return data.key end
      return nil
   end
   
   local function loadSDK()
      local url = "https://junkie-development.de/sdk/JunkieKeySystem.lua"
      local ok, src = pcall(function() return game:HttpGet(url, true) end)
      if not ok or not src or #src < 100 then return nil end
      local ok2, chunk = pcall(loadstring, src)
      if not ok2 or not chunk then return nil end
      local ok3, sdk = pcall(chunk)
      if ok3 and sdk then return sdk end
      return nil
   end
   
   print("[KEY] Creating tab...")
   local KeyTab
   local ok, err = pcall(function()
      KeyTab = Window:CreateTab("🔑 Key", nil)
   end)
   
   if not ok or not KeyTab then
      warn("[KEY] ERROR creating tab:", err)
      return nil
   end
   
   print("[KEY] Tab created successfully!")
   
   pcall(function()
      KeyTab:CreateSection("Key System")
      KeyTab:CreateSection("Saved on this device")
   end)
   
   local keyVerified = false
   local enteredKey = ""
   local inputRef
   
   local function notify(msg, isError)
      pcall(function()
         Rayfield:Notify({
            Title = "Key",
            Content = (isError and "❌ " or "")..msg,
            Duration = isError and 5 or 3
         })
      end)
   end
   
   -- IMPROVED TAB DELETION
   local function deleteTab()
      print("[KEY] 🗑️ Starting tab deletion...")
      
      task.delay(1, function()
         -- Try Rayfield methods first
         pcall(function()
            if KeyTab and typeof(KeyTab.Destroy) == "function" then
               KeyTab:Destroy()
               print("[KEY] ✅ Tab destroyed via :Destroy()")
            elseif KeyTab and typeof(KeyTab.Hide) == "function" then
               KeyTab:Hide()
               print("[KEY] ✅ Tab hidden via :Hide()")
            end
         end)
         
         -- Aggressive manual deletion
         task.wait(0.5)
         print("[KEY] Starting manual cleanup...")
         
         pcall(function()
            local PlayerGui = LP:WaitForChild("PlayerGui")
            local deleted = 0
            
            for _, gui in pairs(PlayerGui:GetChildren()) do
               if gui.Name:find("Rayfield") or gui.ClassName == "ScreenGui" then
                  
                  for _, obj in pairs(gui:GetDescendants()) do
                     local shouldDelete = false
                     
                     -- Find Key tab button
                     if obj:IsA("TextButton") or obj:IsA("ImageButton") then
                        local fullText = obj.Text or ""
                        
                        -- Check for text in children
                        for _, child in pairs(obj:GetChildren()) do
                           if child:IsA("TextLabel") then
                              fullText = fullText .. " " .. (child.Text or "")
                           end
                        end
                        
                        if fullText:find("🔑") or (fullText:find("Key") and not fullText:find("Keybind")) then
                           shouldDelete = true
                        end
                     end
                     
                     -- Find Key page/frame
                     if obj:IsA("ScrollingFrame") or obj:IsA("Frame") then
                        -- Check if it contains key verification buttons
                        for _, child in pairs(obj:GetDescendants()) do
                           if child:IsA("TextButton") then
                              local txt = child.Text or ""
                              if txt:find("Verify") or txt:find("Get Key") or txt:find("Discord") then
                                 -- Make sure it's our key tab by checking for multiple buttons
                                 local verifyCount = 0
                                 for _, sibling in pairs(obj:GetDescendants()) do
                                    if sibling:IsA("TextButton") and (sibling.Text:find("Verify") or sibling.Text:find("Get Key")) then
                                       verifyCount = verifyCount + 1
                                    end
                                 end
                                 if verifyCount >= 2 then
                                    shouldDelete = true
                                    break
                                 end
                              end
                           end
                        end
                     end
                     
                     if shouldDelete then
                        local name = obj.Name or "Unknown"
                        local class = obj.ClassName
                        obj:Destroy()
                        deleted = deleted + 1
                        print(string.format("[KEY] ✅ Deleted: %s (%s)", name, class))
                     end
                  end
               end
            end
            
            if deleted > 0 then
               print(string.format("[KEY] ✅ Manual cleanup complete! Deleted %d objects", deleted))
            else
               print("[KEY] ⚠️ No objects found to delete")
            end
         end)
      end)
   end
   
   pcall(function()
      inputRef = KeyTab:CreateInput({
         Name = "Enter Key",
         PlaceholderText = "Paste key here",
         RemoveTextAfterFocusLost = false,
         Callback = function(t) enteredKey = tostring(t or ""):gsub("%s+", "") end
      })
   end)
   
   pcall(function()
      KeyTab:CreateButton({
         Name = "Get Key Link",
         Callback = function()
            if keyVerified then return notify("Already verified!") end
            if not Config or not Config.api then return notify("No API key", true) end
            
            notify("Loading...")
            local sdk = loadSDK()
            if not sdk then return notify("SDK failed", true) end
            
            local getLinkFn = sdk.getLink or sdk.GetLink
            if not getLinkFn then return notify("No getLink", true) end
            
            local ok, res = pcall(getLinkFn, Config.api, Config.provider, Config.service)
            if not ok or not res then return notify("Link failed", true) end
            
            local link = res
            if type(res) == "table" then link = res.url or res.link end
            if not link or link == "" then return notify("No link", true) end
            
            pcall(function() setclipboard(link) end)
            notify("✅ Link copied!")
         end
      })
   end)
   
   local function verify(key, silent)
      if keyVerified or not key or key == "" then return end
      if not Config or not Config.api then return notify("No API", true) end
      
      if not silent then notify("Verifying...") end
      
      local sdk = loadSDK()
      if not sdk then return notify("SDK error", true) end
      
      local verifyFn = sdk.verifyKey or sdk.VerifyKey
      if not verifyFn then return notify("No verify", true) end
      
      local ok, res = pcall(verifyFn, Config.api, key, Config.service)
      if not ok then return notify("Verify failed", true) end
      
      local valid = false
      if type(res) == "boolean" then 
         valid = res
      elseif type(res) == "table" and res.valid ~= nil then
         valid = res.valid
      elseif type(res) == "string" and res:lower():find("true") then
         valid = true
      end
      
      if not valid then return notify("Invalid key!", true) end
      
      -- SUCCESS!
      keyVerified = true
      saveKey(key)
      notify("✅ Verified! Tab closing...")
      
      print("[KEY] Key verified successfully! Initiating tab deletion...")
      deleteTab()
      
      if typeof(onVerified) == "function" then
         task.delay(0.3, function() pcall(onVerified) end)
      end
   end
   
   pcall(function()
      KeyTab:CreateButton({
         Name = "Verify Key",
         Callback = function() verify(enteredKey, false) end
      })
   end)
   
   pcall(function()
      KeyTab:CreateButton({
         Name = "Discord",
         Callback = function()
            pcall(function() setclipboard("https://discord.gg/MTXnFfHXW9") end)
            notify("👋 Discord copied!")
         end
      })
   end)
   
   pcall(function()
      Rayfield:Notify({
         Title = "Key Required",
         Content = "Get and verify your key.",
         Duration = 5
      })
   end)
   
   task.defer(function()
      task.wait(0.5)
      local saved = loadKey()
      if saved and saved ~= "" then
         print("[KEY] Found saved key, auto-verifying...")
         enteredKey = saved
         if inputRef and inputRef.Set then
            pcall(function() inputRef:Set(saved) end)
         end
         task.wait(0.3)
         verify(saved, true)
      else
         print("[KEY] No saved key found")
      end
   end)
   
   print("[KEY] Key tab fully loaded!")
   return KeyTab
end