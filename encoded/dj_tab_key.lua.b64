-- dj_tab_key.lua
-- Junkie Key System verification tab
-- Tab deletes itself after verification!

return function(Window, Rayfield, Utils, Config, onVerified)
   local Players = game:GetService("Players")
   local LP = Players.LocalPlayer
   local USER_ID = tostring(LP and LP.UserId or "User")
   
   local function hasFS()
      local env = getfenv()
      return typeof(writefile)=="function" and typeof(readfile)=="function" 
         and typeof(makefolder)=="function" and typeof(isfile)=="function" 
         and typeof(isfolder)=="function" and typeof(delfile)=="function"
   end
   
   local SAVE_DIR = "DJHub/Keys"
   local function ensureSaveDir()
      if not hasFS() then return false end
      pcall(function()
         if not isfolder("DJHub") then makefolder("DJHub") end
         if not isfolder(SAVE_DIR) then makefolder(SAVE_DIR) end
      end)
      return isfolder(SAVE_DIR)
   end
   
   local function sanitize(s) return (tostring(s or "")):gsub("[^%w%-%._ ]","_") end
   local function keyFilePath(service)
      return ("%s/%s_%s.json"):format(SAVE_DIR, sanitize(USER_ID), sanitize(service or "default"))
   end

   local HttpService = game:GetService("HttpService")
   
   local function saveKeyToDisk(service, key)
      if not ensureSaveDir() then return false end
      local data = { key = tostring(key or ""), saved = os.time() }
      local ok, enc = pcall(function() return HttpService:JSONEncode(data) end)
      if not ok then return false end
      local f = keyFilePath(service)
      pcall(function() writefile(f, enc) end)
      return true
   end
   
   local function loadKeyFromDisk(service)
      if not hasFS() then return nil end
      local f = keyFilePath(service)
      if not isfile(f) then return nil end
      local okr, raw = pcall(readfile, f)
      if not okr or type(raw)~="string" or #raw==0 then return nil end
      local okj, obj = pcall(function() return HttpService:JSONDecode(raw) end)
      if okj and type(obj)=="table" and type(obj.key)=="string" and obj.key~="" then
         return obj.key
      end
      return nil
   end
   
   local function deleteSavedKey(service)
      if not hasFS() then return false end
      local f = keyFilePath(service)
      if isfile(f) then pcall(delfile, f) end
      return true
   end

   local function httpFetch(url)
      local ok1, res1 = pcall(function() return game:HttpGet(url, true) end)
      if ok1 and type(res1) == "string" and #res1 > 50 then return res1 end
      
      local ok2, res2 = pcall(function() return game:HttpGetAsync(url) end)
      if ok2 and type(res2) == "string" and #res2 > 50 then return res2 end
      
      local ok3, res3 = pcall(function() return HttpService:GetAsync(url, true) end)
      if ok3 and type(res3) == "string" and #res3 > 50 then return res3 end
      
      return nil
   end

   local function loadJunkieSDK()
      local src = httpFetch("https://junkie-development.de/sdk/JunkieKeySystem.lua")
      if not src or #src < 100 then return nil, "SDK download failed" end
      local ok, chunk = pcall(loadstring, src)
      if not ok or not chunk then return nil, "SDK compile failed" end
      local ok2, sdk = pcall(chunk)
      if not ok2 or not sdk then return nil, "SDK init failed" end
      return sdk
   end

   local function normalizeLink(result)
      if typeof(result) == "string" and result:match("^https?://") then return result end
      if typeof(result) == "table" then
         return result.url or result.link or result.Link 
            or (result.data and result.data.url)
      end
      return nil
   end

   local function normalizeBool(res)
      if typeof(res) == "boolean" then return res end
      if typeof(res) == "string" then
         local s = res:lower()
         if s == "true" or s == "success" then return true end
         if s == "false" or s == "fail" then return false end
      elseif typeof(res) == "table" then
         if res.valid ~= nil then return not not res.valid end
         if res.success ~= nil then return not not res.success end
      end
      return false
   end

   local function callGetLink(Junkie, api, provider, service)
      local fn = Junkie.getLink or Junkie.GetLink
      if not fn then return nil end
      local ok, res = pcall(fn, api, provider, service)
      if ok and res then return normalizeLink(res) end
      return nil
   end

   local function callVerifyKey(Junkie, api, key, service)
      local fn = Junkie.verifyKey or Junkie.VerifyKey
      if not fn then return false end
      local ok, res = pcall(fn, api, key, service)
      if ok then return normalizeBool(res) end
      return false
   end

   -- CREATE THE TAB (old syntax for compatibility)
   local KeyTab = Window:CreateTab("🔑 Key", nil)
   
   print("✅ [KEY] Key tab created")
   
   KeyTab:CreateSection("Key is saved automatically on this device.")
   KeyTab:CreateSection("Verification")

   local enteredKey = ""
   local keyVerified = false
   local inputRef

   local function notify(msg, err)
      Rayfield:Notify({
         Title = "Key",
         Content = (err and "❌ " or "")..msg,
         Duration = err and 5 or 4
      })
   end

   -- DELETE KEY TAB function
   local function deleteKeyTab()
      print("🗑️ [KEY] Destroying Key tab...")
      
      -- Try Tab object methods
      pcall(function()
         if KeyTab then
            if typeof(KeyTab.Destroy) == "function" then
               KeyTab:Destroy()
               print("✅ [KEY] Tab destroyed with :Destroy()")
               return
            elseif typeof(KeyTab.Hide) == "function" then
               KeyTab:Hide()
               print("✅ [KEY] Tab hidden with :Hide()")
               return
            end
         end
      end)
      
      -- Fallback: Manual deletion
      task.delay(0.3, function()
         pcall(function()
            local PlayerGui = LP:WaitForChild("PlayerGui")
            for _, gui in pairs(PlayerGui:GetChildren()) do
               if gui.Name:find("Rayfield") then
                  for _, obj in pairs(gui:GetDescendants()) do
                     local del = false
                     
                     if obj:IsA("TextButton") or obj:IsA("ImageButton") then
                        local txt = obj.Text or ""
                        for _, c in pairs(obj:GetChildren()) do
                           if c:IsA("TextLabel") then txt = txt.." "..(c.Text or "") end
                        end
                        if txt:find("🔑") or (txt:find("Key") and not txt:find("Keybind")) then 
                           del = true 
                        end
                     end
                     
                     if obj:IsA("ScrollingFrame") then
                        for _, c in pairs(obj:GetDescendants()) do
                           if c:IsA("TextButton") and (c.Text:find("Verify") or c.Text:find("Get Key")) then
                              del = true
                              break
                           end
                        end
                     end
                     
                     if del then
                        print("✅ [KEY] Fallback delete:", obj.Name)
                        obj:Destroy()
                     end
                  end
               end
            end
            print("✅ [KEY] Fallback cleanup complete")
         end)
      end)
      
      print("✅ [KEY] Tab removal initiated!")
   end

   inputRef = KeyTab:CreateInput({
      Name = "Enter your key",
      PlaceholderText = "Paste key...",
      RemoveTextAfterFocusLost = false,
      Callback = function(t) enteredKey = tostring(t):gsub("%s+","") end
   })

   KeyTab:CreateButton({
      Name = "Get Key (copy link)",
      Callback = function()
         if keyVerified then return notify("Already verified!") end
         if not Config or not Config.api or Config.api == "" then
            return notify("API not configured", true)
         end
         
         notify("Loading SDK...")
         local sdk, why = loadJunkieSDK()
         if not sdk then return notify("SDK failed: "..why, true) end

         local link = callGetLink(sdk, Config.api, Config.provider, Config.service)
         if not link then return notify("Link failed", true) end

         pcall(function() setclipboard(link) end)
         if Utils and Utils.copyToClipboard then Utils.copyToClipboard(link) end
         notify("✅ Link copied!\n"..link)
      end
   })

   local function verify(key, fromSaved)
      if keyVerified or not key or key == "" then return end
      if not Config or not Config.api or Config.api == "" then
         return notify("API not configured", true)
      end
      
      if not fromSaved then notify("Verifying...") end

      local sdk = loadJunkieSDK()
      if not sdk then return notify("SDK failed", true) end

      local valid = callVerifyKey(sdk, Config.api, key, Config.service)
      if not valid then
         if fromSaved then deleteSavedKey(Config.service) end
         return notify("Invalid key!", true)
      end

      keyVerified = true
      saveKeyToDisk(Config.service, key)
      notify("✅ Verified! Tab closing...")

      -- DESTROY TAB AFTER 1.5 SECONDS
      task.delay(1.5, deleteKeyTab)

      if typeof(onVerified) == "function" then
         task.delay(0.2, function() pcall(onVerified) end)
      end
   end

   KeyTab:CreateButton({
      Name = "Verify Key",
      Callback = function() verify(enteredKey, false) end
   })

   KeyTab:CreateButton({
      Name = "Join Discord",
      Callback = function()
         pcall(function() setclipboard("https://discord.gg/MTXnFfHXW9") end)
         notify("👋 Discord copied!")
      end
   })

   Rayfield:Notify({
      Title = "Key Required",
      Content = "Get & verify your key to continue.",
      Duration = 5
   })

   -- Auto-load saved key
   task.defer(function()
      task.wait(0.5)
      local saved = loadKeyFromDisk(Config and Config.service)
      if saved and saved ~= "" then
         enteredKey = saved
         if inputRef and typeof(inputRef.Set) == "function" then
            pcall(function() inputRef:Set(saved) end)
         end
         task.wait(0.3)
         verify(saved, true)
      end
   end)
   
   print("✅ [KEY] Key tab fully loaded")
   
   return KeyTab
end